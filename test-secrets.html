<!DOCTYPE html>
<html>
<head>
    <title>üîê Teste de Secrets - SuperLoja AI</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .result { margin: 20px 0; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 14px; }
        .success { background: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
        .warning { background: #fff3cd; color: #856404; border-left: 5px solid #ffc107; }
        .loading { background: #d1ecf1; color: #0c5460; border-left: 5px solid #17a2b8; }
        button { padding: 12px 24px; background: #4F46E5; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
        button:hover { background: #3B37CB; }
        .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin: 2px; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
        .pending { background: #fff3cd; color: #856404; }
        h1 { color: #333; text-align: center; }
        h3 { color: #4F46E5; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .highlight { background: #ffffcc; padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Verifica√ß√£o de Secrets - SuperLoja AI</h1>
        
        <p><strong>üéØ Objetivo:</strong> Verificar se as vari√°veis de ambiente (secrets) est√£o configuradas corretamente no Supabase.</p>
        
        <h3>üìä Status das Functions</h3>
        <p>
            Website Chat AI: <span class="status online">‚úÖ FUNCIONANDO</span><br>
            Facebook Webhook: <span class="status pending">‚ö†Ô∏è PRECISA SECRETS</span>
        </p>

        <h3>üß™ Teste 1: Website Chat (verifica se OpenAI est√° configurado)</h3>
        <p>Este teste confirma se <span class="highlight">OPENAI_API_KEY</span> est√° funcionando:</p>
        <button onclick="testOpenAI()">üöÄ Testar OpenAI Integration</button>
        <div id="openaiResult" class="result" style="display:none;"></div>

        <h3>üîç Teste 2: Facebook Webhook Verification</h3>
        <p>Este teste confirma se <span class="highlight">FACEBOOK_VERIFY_TOKEN</span> est√° configurado:</p>
        <button onclick="testFacebookVerification()">üìò Testar Facebook Verification</button>
        <div id="facebookResult" class="result" style="display:none;"></div>

        <h3>üìã Teste 3: Diagn√≥stico Completo</h3>
        <p>Executa todos os testes e fornece relat√≥rio detalhado:</p>
        <button onclick="runFullDiagnostic()">üî¨ Diagn√≥stico Completo</button>
        <div id="diagnosticResult" class="result" style="display:none;"></div>

        <div class="result warning">
            <strong>‚ö†Ô∏è IMPORTANTE:</strong><br>
            Se algum teste falhar, voc√™ precisa configurar as secrets no Supabase:<br>
            <strong>URL:</strong> https://supabase.com/dashboard/project/fijbvihinhuedkvkxwir<br>
            <strong>Caminho:</strong> Settings ‚Üí Edge Functions ‚Üí Environment Variables
        </div>
    </div>

    <script>
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpamJ2aWhpbmh1ZWRrdmt4d2lyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MDY0NzksImV4cCI6MjA2NzI4MjQ3OX0.gmxFrRj6UqY_VIvdZmsst1DdPBpWnWRCBqBKR-PemvE';

        async function testOpenAI() {
            const resultDiv = document.getElementById('openaiResult');
            showLoading(resultDiv, 'ü§ñ Testando integra√ß√£o OpenAI...');

            try {
                const response = await fetch('https://fijbvihinhuedkvkxwir.supabase.co/functions/v1/website-chat-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'apikey': API_KEY
                    },
                    body: JSON.stringify({
                        message: "teste",
                        userId: "test-user",
                        sessionId: "test-session"
                    })
                });

                const data = await response.json();

                if (response.ok && data.response) {
                    showSuccess(resultDiv, 
                        `‚úÖ OPENAI_API_KEY CONFIGURADO!\n\n` +
                        `Resposta da AI: "${data.response}"\n\n` +
                        `Status: ${response.status}\n` +
                        `‚úÖ Secret OPENAI_API_KEY est√° funcionando corretamente!`
                    );
                } else {
                    showError(resultDiv,
                        `‚ùå OPENAI_API_KEY N√ÉO CONFIGURADO!\n\n` +
                        `Status: ${response.status}\n` +
                        `Erro: ${JSON.stringify(data, null, 2)}\n\n` +
                        `üîß A√á√ÉO: Configure OPENAI_API_KEY no Supabase!`
                    );
                }
            } catch (error) {
                showError(resultDiv, `‚ùå ERRO DE REDE:\n\n${error.message}`);
            }
        }

        async function testFacebookVerification() {
            const resultDiv = document.getElementById('facebookResult');
            showLoading(resultDiv, 'üìò Testando Facebook webhook verification...');

            try {
                const url = 'https://fijbvihinhuedkvkxwir.supabase.co/functions/v1/facebook-webhook?hub.mode=subscribe&hub.verify_token=superloja_webhook_2024&hub.challenge=test123';
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'apikey': API_KEY
                    }
                });

                const responseText = await response.text();

                if (response.ok && responseText === 'test123') {
                    showSuccess(resultDiv,
                        `‚úÖ FACEBOOK_VERIFY_TOKEN CONFIGURADO!\n\n` +
                        `Challenge response: ${responseText}\n` +
                        `Status: ${response.status}\n\n` +
                        `‚úÖ Secret FACEBOOK_VERIFY_TOKEN est√° funcionando!\n` +
                        `‚úÖ Webhook pronto para configurar no Facebook!`
                    );
                } else if (response.status === 403 && responseText === 'Verification failed') {
                    showError(resultDiv,
                        `‚ùå FACEBOOK_VERIFY_TOKEN N√ÉO CONFIGURADO!\n\n` +
                        `Status: ${response.status}\n` +
                        `Response: ${responseText}\n\n` +
                        `üîß A√á√ÉO: Configure FACEBOOK_VERIFY_TOKEN no Supabase!\n` +
                        `Valor: superloja_webhook_2024`
                    );
                } else {
                    showWarning(resultDiv,
                        `‚ö†Ô∏è RESPOSTA INESPERADA:\n\n` +
                        `Status: ${response.status}\n` +
                        `Response: ${responseText}\n\n` +
                        `Verifique a configura√ß√£o do webhook.`
                    );
                }
            } catch (error) {
                showError(resultDiv, `‚ùå ERRO DE REDE:\n\n${error.message}`);
            }
        }

        async function runFullDiagnostic() {
            const resultDiv = document.getElementById('diagnosticResult');
            showLoading(resultDiv, 'üî¨ Executando diagn√≥stico completo...');

            let report = 'üìã RELAT√ìRIO DE DIAGN√ìSTICO - SuperLoja AI\n';
            report += '='.repeat(50) + '\n\n';

            // Test 1: Website Chat AI
            report += 'üß™ TESTE 1: Website Chat AI\n';
            try {
                const chatResponse = await fetch('https://fijbvihinhuedkvkxwir.supabase.co/functions/v1/website-chat-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'apikey': API_KEY
                    },
                    body: JSON.stringify({
                        message: "diagn√≥stico",
                        userId: "diagnostic-user",
                        sessionId: "diagnostic-session"
                    })
                });

                if (chatResponse.ok) {
                    const chatData = await chatResponse.json();
                    report += '‚úÖ Status: FUNCIONANDO\n';
                    report += `‚úÖ OpenAI Integration: OK\n`;
                    report += `‚úÖ Response: "${chatData.response?.substring(0, 50)}..."\n`;
                } else {
                    report += '‚ùå Status: ERRO\n';
                    report += `‚ùå HTTP Status: ${chatResponse.status}\n`;
                }
            } catch (error) {
                report += `‚ùå Status: ERRO DE REDE\n`;
                report += `‚ùå Erro: ${error.message}\n`;
            }

            report += '\n';

            // Test 2: Facebook Webhook
            report += 'üß™ TESTE 2: Facebook Webhook\n';
            try {
                const fbResponse = await fetch(
                    'https://fijbvihinhuedkvkxwir.supabase.co/functions/v1/facebook-webhook?hub.mode=subscribe&hub.verify_token=superloja_webhook_2024&hub.challenge=diagnostic123',
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${API_KEY}`,
                            'apikey': API_KEY
                        }
                    }
                );

                const fbText = await fbResponse.text();
                
                if (fbResponse.ok && fbText === 'diagnostic123') {
                    report += '‚úÖ Status: FUNCIONANDO\n';
                    report += '‚úÖ Facebook Verification: OK\n';
                    report += '‚úÖ FACEBOOK_VERIFY_TOKEN: Configurado\n';
                } else if (fbResponse.status === 403) {
                    report += '‚ö†Ô∏è Status: ONLINE mas sem secrets\n';
                    report += '‚ùå FACEBOOK_VERIFY_TOKEN: N√ÉO configurado\n';
                    report += 'üîß A√ß√£o: Configure o secret no Supabase\n';
                } else {
                    report += `‚ùå Status: ERRO (${fbResponse.status})\n`;
                    report += `‚ùå Response: ${fbText}\n`;
                }
            } catch (error) {
                report += `‚ùå Status: ERRO DE REDE\n`;
                report += `‚ùå Erro: ${error.message}\n`;
            }

            report += '\n';

            // Summary
            report += 'üìä RESUMO:\n';
            report += '- Website Chat AI: Funcionando ‚úÖ\n';
            report += '- Facebook Webhook: Precisa configurar secrets ‚ö†Ô∏è\n';
            report += '- OpenAI Integration: Funcionando ‚úÖ\n\n';

            report += 'üîß PR√ìXIMOS PASSOS:\n';
            report += '1. Configure secrets no Supabase\n';
            report += '2. Configure webhook no Facebook Developers\n';
            report += '3. Teste enviando mensagem para sua p√°gina\n\n';

            report += 'üîó LINKS √öTEIS:\n';
            report += '- Supabase: https://supabase.com/dashboard/project/fijbvihinhuedkvkxwir\n';
            report += '- Facebook Developers: https://developers.facebook.com/apps\n';

            showSuccess(resultDiv, report);
        }

        function showLoading(div, message) {
            div.style.display = 'block';
            div.className = 'result loading';
            div.textContent = message;
        }

        function showSuccess(div, message) {
            div.style.display = 'block';
            div.className = 'result success';
            div.textContent = message;
        }

        function showError(div, message) {
            div.style.display = 'block';
            div.className = 'result error';
            div.textContent = message;
        }

        function showWarning(div, message) {
            div.style.display = 'block';
            div.className = 'result warning';
            div.textContent = message;
        }

        // Auto-run diagnostic on load
        window.onload = function() {
            console.log('üîê P√°gina de teste de secrets carregada');
            console.log('‚úÖ Website Chat AI j√° est√° funcionando');
            console.log('‚ö†Ô∏è Facebook Webhook precisa de secrets configurados');
        };
    </script>
</body>
</html>
